---
title: "Visualization Markdown"
output: html_document
---

```{r}
# All code written by Evan Collins
# 14 February 2022, updated 12 February 2023, updated 7 July 2023
# Any questions can be sent to evantomcollins@gmail.com
```


```{r, warning = F, message = F}
# Load packages
library(dplyr)
library(plotly)
library(ggplot2)
```

```{r}
# Load atlas coordinate files
parcel_name_vertex_num_df <- read.csv("files/parcel_name_vertex_num_df.csv")
parcel_names <- parcel_name_vertex_num_df$parcel_names
vertex_number_by_parcel <- parcel_name_vertex_num_df$num_vertex

atlas_positions <- read.csv("files/atlas_positions.csv")
atlas_indices <- read.csv("files/atlas_indices.csv")

atlas_LH_positions <- read.csv("files/atlas_LH_positions.csv")
atlas_LH_indices <- read.csv("files/atlas_LH_indices.csv")

atlas_RH_positions <- read.csv("files/atlas_RH_positions.csv")
atlas_RH_indices <- read.csv("files/atlas_RH_indices.csv")

parcel_dict <- read.csv("files/parcel_dict.csv")

# Coloring: Example data from Scientific Reports publication
parcel_electrode_count <- read.csv("files/parcel_electrode_count.csv")

# Coloring: Example data from Parcelsynth
parcelsynth_df <- read.csv("files/parcelsynth_all_690parcels.csv")
```

```{r}
# One example of how to compute RGB values for parcels
# Function to return list of RGB colors assigned to each parcel (i.e., their component vertices) with color intensity reflecting magnitude of input data column

# Input 1: dataframe = dataframe name with 690 rows corresponding to 690 parcels (first 345 should be left parcels; last 345 should be right parcels)
# Input 2: column = column name with by parcel frequency data
# Output: data_colors = list of three 690-length vectors with RGB colors for 690 parcels

# Note: If all values in provided column are positive, gradient will be white to red.
# Note: If all values in provided column are negative, gradient will be blue to white.
# Note: If values in provided column are negative and positive, gradient will be blue to white to red.

color_parcels_by_data <- function(dataframe, column){
  column_number <- which(colnames(dataframe) == column)
  data_colors_R <- col2rgb(ggplot_build(ggplot(dataframe, aes(x=as.numeric(dataframe[,column_number]), y=as.numeric(dataframe[,column_number]), color=as.numeric(dataframe[,column_number]))) + geom_point() + scale_color_gradientn(limits = c(-pmax(abs(min(as.numeric(dataframe[,column_number]))), abs(max(as.numeric(dataframe[,column_number])))), pmax(abs(min(as.numeric(dataframe[,column_number]))), abs(max(as.numeric(dataframe[,column_number]))))), colors = c("blue", "white", "red")))$data[[1]][[1]])[1,]
  data_colors_G <- col2rgb(ggplot_build(ggplot(dataframe, aes(x=as.numeric(dataframe[,column_number]), y=as.numeric(dataframe[,column_number]), color=as.numeric(dataframe[,column_number]))) + geom_point() + scale_color_gradientn(limits = c(-pmax(abs(min(as.numeric(dataframe[,column_number]))), abs(max(as.numeric(dataframe[,column_number])))), pmax(abs(min(as.numeric(dataframe[,column_number]))), abs(max(as.numeric(dataframe[,column_number]))))), colors = c("blue", "white", "red")))$data[[1]][[1]])[2,]
  data_colors_B <- col2rgb(ggplot_build(ggplot(dataframe, aes(x=as.numeric(dataframe[,column_number]), y=as.numeric(dataframe[,column_number]), color=as.numeric(dataframe[,column_number]))) + geom_point() + scale_color_gradientn(limits = c(-pmax(abs(min(as.numeric(dataframe[,column_number]))), abs(max(as.numeric(dataframe[,column_number])))), pmax(abs(min(as.numeric(dataframe[,column_number]))), abs(max(as.numeric(dataframe[,column_number]))))), colors = c("blue", "white", "red")))$data[[1]][[1]])[3,]
  data_colors <- list(data_colors_R, data_colors_G, data_colors_B)
  return(data_colors)
}
```

```{r}
# Function to return list of 3D mesh interactive figures for whole, LH, RH, deep LH, and deep RH parcellated brains in Yale Brain Atlas space.
# Input 1: R_values = 690-length vector of R color values for 690 parcels (on RGB scale)
# Input 2: G_values = 690-length vector of G color values for 690 parcels (on RGB scale)
# Input 3: B_values = 690-length vector of B color values for 690 parcels (on RGB scale)
# Input 4: extra_text_values_df = 690-length vector of any additional information to be displayed in hovertext for 690 parcels
# Output: interactive_brain_list = list of three 3D interactive figures for whole, LH, and RH parcellated brains

plot_interactive_brain <-
  function(R_values = NULL,
           G_values = NULL ,
           B_values = NULL ,
           extra_text_values = NULL) {
    if (is.null(R_values)) {
      # if no colors provided, default to color-coded brain
      R_values <- parcel_dict$YBA_R_color
      G_values <- parcel_dict$YBA_G_color
      B_values <- parcel_dict$YBA_B_color
    }
    
    interactive_brain_list <- list()
    interactive_brain_list[[1]] <- plot_ly(
      type = "mesh3d",
      x = atlas_positions$x,
      y = atlas_positions$y,
      z = atlas_positions$z,
      vertexcolor = rep(
        rgb(R_values / 255, G_values / 255, B_values / 255, 1),
        vertex_number_by_parcel
      ),
      i = atlas_indices$i,
      j = atlas_indices$j,
      k = atlas_indices$k,
      hovertext = paste0(
        "Parcel: ",
        rep(parcel_names, vertex_number_by_parcel),
        "<br>Value: ",
        rep(extra_text_values, vertex_number_by_parcel)
      )
    ) %>%
      layout(hoverlabel = list(
        bgcolor = "white",
        bordercolor = "darkblue",
        font = list(size = 15, family = "Verdana")
      )) %>%
      config(displaylogo = F, displayModeBar = F) %>%
      layout(scene = list(camera = list(
        eye = list(x = 0, y = 0, z = 1.4),
        up = list(x = 0, y = 1, z = 0),
        center = list(x = 0, y = 0, z = 0)
      )))
    
    
    interactive_brain_list[[2]] <- plot_ly(
      type = "mesh3d",
      x = atlas_LH_positions$x,
      y = atlas_LH_positions$y,
      z = atlas_LH_positions$z,
      vertexcolor = rep(
        rgb(R_values / 255, G_values / 255, B_values / 255, 1),
        vertex_number_by_parcel
      )[1:31509],
      opacity = 1,
      i = atlas_LH_indices$i,
      j = atlas_LH_indices$j,
      k = atlas_LH_indices$k,
      hovertext = paste0(
        "Parcel: ",
        rep(parcel_names, vertex_number_by_parcel)[1:31509],
        "<br>Value: ",
        rep(extra_text_values, vertex_number_by_parcel)[1:31509]
      )
    ) %>%
      layout(hoverlabel = list(
        bgcolor = "white",
        bordercolor = "darkblue",
        font = list(size = 15, family = "Verdana")
      )) %>%
      config(displaylogo = F, displayModeBar = F) %>%
      layout(scene = list(camera = list(
        eye = list(x = 1.5, y = 0, z = 0),
        up = list(x = 0, y = 0, z = 1),
        center = list(x = 0, y = 0, z = 0)
      )))
    
    interactive_brain_list[[3]] <- plot_ly(
      type = "mesh3d",
      x = atlas_RH_positions$x,
      y = atlas_RH_positions$y,
      z = atlas_RH_positions$z,
      vertexcolor = rep(
        rgb(R_values / 255, G_values / 255, B_values / 255, 1),
        vertex_number_by_parcel
      )[31510:length(atlas_positions$x)],
      i = atlas_RH_indices$i,
      j = atlas_RH_indices$j,
      k = atlas_RH_indices$k,
      hovertext = paste0(
        "Parcel: ",
        rep(parcel_names, vertex_number_by_parcel)[31510:length(rep(parcel_names, vertex_number_by_parcel))],
        "<br>Value: ",
        rep(extra_text_values, vertex_number_by_parcel)[31510:length(rep(parcel_names, vertex_number_by_parcel))]
      )
    ) %>%
      layout(hoverlabel = list(
        bgcolor = "white",
        bordercolor = "darkblue",
        font = list(size = 15, family = "Verdana")
      )) %>%
      config(displaylogo = F, displayModeBar = F) %>%
      layout(scene = list(camera = list(
        eye = list(x = 1.3, y = 0, z = 0),
        up = list(x = 0, y = 0, z = 1),
        center = list(x = 0, y = 0, z = 0)
      )))
    return(interactive_brain_list)
}
```


# Get R, G, B, colors based on example data

```{r}
# for electrode count data
parcel_electrode_count_colors <- color_parcels_by_data(parcel_electrode_count, "freq")
```

```{r}
# for Parcelsynth data for specific functional term, e.g., "language"
parcel_parcelsynth_language_colors <- color_parcels_by_data(parcelsynth_df, "language")
```


# Visualizations - Default Yale Brain Atlas colors

```{r}
ex0 <- 
  plot_interactive_brain()
```

```{r}
# Whole brain
ex0[[1]]
```

```{r}
# LH
ex0[[2]]
```

```{r}
# RH
ex0[[3]]
```


# Visualizations - Electrode count example

```{r}
ex1 <-
  plot_interactive_brain(
    R_values = parcel_electrode_count_colors[[1]], 
    G_values = parcel_electrode_count_colors[[2]], 
    B_values = parcel_electrode_count_colors[[3]], 
    extra_text_values = parcel_electrode_count$freq
    )
```

```{r}
# Whole brain
ex1[[1]]
```

```{r}
# LH
ex1[[2]]
```

```{r}
# RH
ex1[[3]]
```

# Visualizations - Parcelsynth "language" z-score example

```{r}
ex2 <-
  plot_interactive_brain(
    R_values = parcel_parcelsynth_language_colors[[1]], 
    G_values = parcel_parcelsynth_language_colors[[2]], 
    B_values = parcel_parcelsynth_language_colors[[3]], 
    extra_text_values = parcelsynth_df$language
    )
```

```{r}
# Whole brain
ex2[[1]]
```

```{r}
# LH
ex2[[2]]
```

```{r}
# RH
ex2[[3]]
```